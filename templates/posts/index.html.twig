{% extends '/base.html.twig' %}

{% block title %}
    Infaux
{% endblock %}
{% block gtag %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-107718823-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'UA-107718823-2');
    </script>
{% endblock %}
{% block meta_description %}
    <meta name="description"
          content="Agence web à Lens. Conception et développement de sites sur mesure. Communication digitale, référencement SEO Google."/>{% endblock %}
{% block meta_keywords %}
    <meta name="keywords"
          content="Agence web de communication web marketing, stratégie digitale à Lens, France, creation site internet, agence de développement web, Création site internet, Lens, Lille, France, creation site internet, 59, 62, Nord Pas de Calais, Nord, Haut de France, création site internet vitrine, community management entreprise, community management personnel, création boutique en ligne, site internet, site web, création site internet boutique en ligne, Création site web, 75, Paris, Création site web e commerce, agence de référencement, agence seo, seo, référencement naturel, web marketing, agence web, agence de communication, vidéo promotionnelle, vidéo commercial, création site catalogue, création site internet responsive, généré du trafic sur mon site internet, première page google, référencement google, création de site internet france, conseil et webdesign, référencement internet, agence web, site internet responsive, site responsive, création et optimisation de site web, web design et développement de site internet, communication digitale, webmarketing, création site internet boutique en ligne, boutique en ligne, créer boutique en ligne, refonte boutique en ligne, refonte site internet e-commerce, responsive web design, refonte site internet responsive, site adaptable, site internet, site web, création site internet, création site web, responsive, création site internet e-commerce"/>{% endblock %}
{% block meta_robots %}
    <meta name="robots" content="unavailable_after: [date ]">{% endblock %}
{% block google %}
    <meta name="google" content="unavailable_after: [date ]">{% endblock %}

{% block style_custom %}

    <style>

    </style>
{% endblock %}
{% block body %}

    {% for message in app.flashes('success') %}
        <div class="alert alert-success">
            {{ message }}
        </div>
    {% endfor %}
    {% for message in app.flashes('error') %}
        <div class="alert alert-danger">
            {{ message }}
        </div>
    {% endfor %}

    <div class="container" style="margin-top: 100px;">


        {% if app.user %}
            <div class="formPost">
                {{ form_start(postForm,{'attr':{'class':'postForm'}}) }}
                <div class="img"
                     style="background:url(https://images.unsplash.com/photo-1463453091185-61582044d556?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1650&q=80)">
                </div>
                <div class="form-group">
                    {{ form_row(postForm.text,{'attr':{'class':'postForm__textarea form-control input-lg txta','placeholder':'Poster un nouveau post'},'label': ' '}) }}
                </div>
                <div class="d-flex justify-content-end btn-submit">
                    <div class="form-group">

                        {{ form_row(postForm.submit,{'attr':{'class': 'formPost'},'label': 'Poster'}) }}

                    </div>
                </div>
                {{ form_end(postForm) }}
            </div>
        {% endif %}


        {% for post in posts %}


            <div class="post-container">
                <div class="content">
                    <div class="header">
                        <div class="top">
                            <button type="button" class="btn btn-primary" data-toggle="modal"
                                    data-target="#profil-{{ post.user.id }}">
                                <div class="img"
                                     style="background:url('/uploads/images/users/{{ post.user.image }}')"></div>
                            </button>
                            <div class="modal fade" id="profil-{{ post.user.id }}" tabindex="-1" role="dialog"
                                 aria-labelledby="exampleModalLabel" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="exampleModalLabel"></h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="wrap">
                                                <div class="img"
                                                     style="background:url('/uploads/images/users/{{ post.user.image }}')"></div>
                                            </div>
                                            <div class="username">{{ post.user.username }}</div>
                                            <div class="description">But I must explain to you how all this mistaken
                                                idea of denouncing pleasure and
                                            </div>
                                            {% if app.user %}
                                                {% if  app.user == post.user %}
                                                    <div class="lien_profil"><a
                                                                href="{{ path('account.show',{'id': post.user.id} ) }}">Voir mon
                                                            profil</a></div>
                                                {% else %}
                                                    <div class="lien_profil"><a
                                                                href="{{ path('account.show',{'id': post.user.id} ) }}">Voir le
                                                            profil</a></div>
                                                    <div data-userId="{{ post.user.id }}"
                                                         onclick="handleAddUserFollow(event)"
                                                         data-action="{{ path('follow.add',{"id":post.user.id}) }}"
                                                         class="followUser">
                                                        <span class="followStatus">Suivre</span>

                                                    </div>
                                                {% endif %}
                                            {% else %}
                                                <div class="lien_profil"><a
                                                            href="{{ path('account.show',{'id': post.user.id} ) }}">Voir le
                                                        profil</a></div>
                                            {% endif %}





                                        </div>
                                    </div>
                                </div>
                            </div>

                            {# <div class="img" style="background:url({{ asset('/img/favicon96.png') }})"></div> #}
                            <div class="infos">
                                <div class="left">
                                    <p class="username"><strong>{{ post.user.username }}</strong>
                                    </p>
                                    <p class="date">
                                       <span data-createdAt="{{ post.createdAt | date('U') }}"
                                             class="number p-date">{{ post.createdAt | date('U') }}</span>
                                    </p>
                                </div>
                                <div class="option">

                                    <button type="button" class="btn btn-primary" data-toggle="modal"
                                            data-target="#modal-post-{{ post.id }}">
                                        <i class="icon-dots-horizontal-triple"></i>
                                    </button>
                                    <div class="modal fade" id="modal-post-{{ post.id }}" tabindex="-1" role="dialog"
                                         aria-labelledby="exampleModalLabel" aria-hidden="true">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="exampleModalLabel"></h5>
                                                    <button type="button" class="close" data-dismiss="modal"
                                                            aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body">

                                                    <div class="actions">
                                                        {% if app.user %}
                                                            <div class="icons first">
                                                                <div onclick="handleAddPostPinned(event)"
                                                                     data-action="{{ path('post.addPin',{'id':post.id}) }}"
                                                                     class="pinnedPost">
                                                                    <i class="icon-pushpin"></i><span class="pinText">Epingler ce post</span>
                                                                </div>
                                                            </div>
                                                        {% endif %}
                                                        <div class="icons">
                                                            <div onclick="handleAddReport(event)"
                                                                 data-action="{{ path('report.add',{"entity":"post",'id':post.id}) }}"
                                                                 class="reportForm">

                                                                <i class="icon-blocked"></i><span class="number ">Signaler ce contenu</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {# <div class="btn-opt-post" onclick="dropdown();"><i class="icon-dots-horizontal-triple"></i></div>
                                    <div class="opt-post" id="opt-post">a</div> #}


                                </div>
                            </div>
                        </div>
                        <div class="l-post">
                            <p class="text">{{ post.text }}</p>
                        </div>

                        <div class="actions">
                            <div class="icons">
                                <div onclick="handleAddLike(event)"
                                     data-action="{{ path('like.add',{"entity":"post",'id':post.id}) }}"
                                     class="likeForm">
                                    {% if app.user %}
                                        {% set liked = false %}
                                        {% for like in post.likes %}
                                            {% if like.user == app.user and like.post == post %}
                                                {% set liked = true %}
                                            {% else %}
                                                {% set liked = false %}
                                            {% endif %}
                                        {% endfor %}

                                        {% if liked %}
                                            <i class="icon-heart heart-dilike"></i>
                                        {% else %}
                                            <i class="icon-heart heart-like"></i>
                                        {% endif %}

                                    {% else %}
                                        <i class="icon-heart heart-like"></i>
                                    {% endif %}

                                    <span class="number">{{ post.likes|length }}</span>
                                </div>
                                <div class="icons">
                                    <i class="icon-bubble"></i><span class="number">{{ post.comments | length }}</span>
                                </div>
                            </div>
                            <div
                                    class="btn btn-primaire view-more-button"
                                    onclick="getNextComment(event)"
                                    data-page="0"
                                    data-href="{{ path('comment.paginate',{'post': post.id}) }}"
                                    data-post="{{ post.id }}"

                            >Voir plus
                            </div>
                        </div>
                    </div>

                </div>


                <div class="wrapper-comments">


                    {% set comments = post.comments %}
                    {% for comment in comments  if comments %}

                        <div class="comments-container">


                            <div class="content">
                                <div class="header">
                                    <div class="top">
                                        <div class="img"
                                             style="background:url('{{ "/uploads/images/users/" ~ comment.user.image ?? 'adorable.png' }}')">
                                        </div>
                                    </div>


                                    <div class="l-post right">
                                        <div class="top">
                                            <p class="username"><strong>{{ comment.user }}</strong><span
                                                        data-createdAt="{{ comment.createdAt | date('U') }}"
                                                        class="number p-date">{{ comment.createdAt | date('U') }}</span>
                                            </p>
                                            <div class="option">
                                                <button type="button" class="btn btn-primary" data-toggle="modal"
                                                        data-target="#commentaire">
                                                    <i class="icon-dots-horizontal-triple"></i>
                                                </button>
                                                <div class="modal fade" id="commentaire" tabindex="-1" role="dialog"
                                                     aria-labelledby="exampleModalLabel" aria-hidden="true">
                                                    <div class="modal-dialog" role="document">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title" id="exampleModalLabel"></h5>
                                                                <button type="button" class="close" data-dismiss="modal"
                                                                        aria-label="Close">
                                                                    <span aria-hidden="true">&times;</span>
                                                                </button>
                                                            </div>
                                                            <div class="modal-body">

                                                                <div class="actions">
                                                                    <div class="icons">
                                                                        <div onclick="handleAddReport(event)"
                                                                             data-action="{{ path('report.add',{"entity":"post",'id':post.id}) }}"
                                                                             class="reportForm">

                                                                            <i class="icon-blocked"></i><span
                                                                                    class="number ">Signaler ce contenu</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <p class="text">{{ comment.textComment }} </p>
                                        <div class="icons">
                                            <div onclick="handleAddLike(event)"
                                                 data-action="{{ path('like.add',{"entity":"comment",'id':comment.id}) }}"
                                                 class="likeForm">

                                                {% if app.user %}
                                                    {% set likedComment = false %}
                                                    {% for like in comment.likes %}
                                                        {% if like.user == app.user and like.comment == comment %}
                                                            {% set likedComment = true %}
                                                        {% else %}
                                                            {% set likedComment = false %}
                                                        {% endif %}
                                                    {% endfor %}

                                                    {% if likedComment %}
                                                        <i class="icon-heart heart-dilike"></i>
                                                    {% else %}
                                                        <i class="icon-heart heart-like"></i>
                                                    {% endif %}

                                                {% else %}
                                                    <i class="icon-heart heart-like"></i>
                                                {% endif %}

                                                <span class="number">
                                            {{ comment.likes|length }}
                                        </span>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="footer">
                                    {# <div class="icons">
                                        <div onclick="handleAddLike(event)"
                                             data-action="{{ path('like.add',{"entity":"comment",'id':comment.id}) }}"
                                             class="likeForm">
                                        <div class="footer">
                                            <div class="icons">
                                                <div onclick="handleAddLike(event)"
                                                     data-action="{{ path('like.add',{"entity":"comment",'id':comment.id}) }}"
                                                     class="likeForm">

                                                    <i class="icon-like">

                                                    </i>
                                                    <span class="number">
                                                {{ comment.likes|length }}
                                            </span>
                                                    </button>
                                                </div>
                                            </div>
                                            <p class="icons">
                                                <i class="icon-alarm"></i><span
                                                        data-createdAt="{{ comment.createdAt | date('U') }}"
                                                        class="number p-date">{{ comment.createdAt | date('U') }}</span>

                                            </p>
                                            <div class="icons">
                                            <div onclick="handleAddReport(event)" data-action="{{ path('report.add',{"entity":"post",'id':post.id}) }}" class="reportForm">

                                                    <i class="fa fa-flag"></i><span class="number ">Signalez</span>

                                            </div>
                                            </div>


                                        </div>
                                    </div>#}

                                </div>


                            </div>
                        </div>

                    {% endfor %}

                </div>

                {% if app.user %}
                    <div class="formComment">
                        <div class="img"
                             style="background:url('/uploads/images/users/{{ app.user.image ?? 'default.png' }}')">
                        </div>
                        <form onsubmit="handleAddComment(event)" name="comment" method="post"
                              action="{{ path('comment.add',{'id':post.id}) }}"
                              class="commentForm">
                            <div class="form-group">
                                <label class="sr-only required" for="comment_textComment">Commentaire</label>
                                {# <textarea id="comment_textComment" name="comment[textComment]" required="required"
                                          class="commentForm__textarea form-control"
                                          placeholder="Votre commentaire ..."></textarea>#}
                                <input type="text" id="comment_textComment" name="comment[textComment]"
                                       required="required"
                                       class="commentForm__textarea form-control input-lg"
                                       placeholder="Votre commentaire ...">
                            </div>
                            <div class="d-flex justify-content-end">
                                <div class="form-group">
                                    <button type="submit" id="comment_submit-post-{{ post.id }}" name="comment[submit]"
                                            class="btn btn-pink btn">Envoyer
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>





                {% endif %}


            </div>


        {% endfor %}
        {{ knp_pagination_render(posts) }}

    </div>

    <div class="page-load-status">
        <div class="infinite-scroll-request">
            <div class="loader-ellips">Chargement
                <span class="loader-ellips__dot"></span>
                <span class="loader-ellips__dot"></span>
                <span class="loader-ellips__dot"></span>
                <span class="loader-ellips__dot"></span>
            </div>
        </div>
        <p class="infinite-scroll-last">Plus aucun post a afficher</p>
        <p class="infinite-scroll-error">No more pages to load</p>
    </div>
{% endblock %}


  {% block javascripts %}
      <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
      <script src="https://unpkg.com/infinite-scroll@3/dist/infinite-scroll.pkgd.min.js"></script>
      {{ encore_entry_script_tags('ajax') }}

      <script>


          function getNextComment(event) {
              console.log($(event.target).closest('.content').next().find('.comments-container'))
              console.log("/comment/post/" + event.target.dataset.post + '?page={{ '{{' }}#{{ '}}' }}')


              var infiniteScroll = $(event.target).closest('.content').next().infiniteScroll({
                  // options
                  path: "/comment/post/" + event.target.dataset.post + '?page={{ '{{' }}#{{ '}}' }}',
                  append: ".comments-container",
                  status: '.page-load-status',
                  button: event.target,
                  history: false,
                  scrollThreshold: false,
                  debug: true
              });
              infiniteScroll.on('load.infiniteScroll', function (res) {
                  $(function () {
                      moment.locale('fr');
                      $(res.currentTarget).find(".p-date").map((x, i) => {
                          i.innerText = moment.unix(i.dataset.createdat).local().fromNow();
                      });
                  });
              });


              /*
              var $viewMoreButton = $(event.target);
              $viewMoreButton.on( 'click', function() {
                  // load next page
                  infiniteScroll.infiniteScroll('loadNextPage');
                  // enable loading on scroll
                  infiniteScroll.infiniteScroll( 'option', {
                      loadOnScroll: true,
                  });
                  // hide button
                  $viewMoreButton.hide();
              });
            */
          }

          document.addEventListener("DOMContentLoaded", function (event) {


              //Post infinite scroll
              var infiniteScroll = $('.transition-fade .container ').infiniteScroll({
                  // options
                  path: '.next a',
                  append: '.post-container',
                  history: false,
                  elementScroll: false,
                  hideNav: '.pagination',
                  status: '.page-load-status'
              });
              infiniteScroll.on('load.infiniteScroll', function () {
                  $(function () {
                      moment.locale('fr');
                      $(".p-date").map((x, i) => {
                          i.innerText = moment.unix(i.dataset.createdat).local().fromNow();
                      });
                  });
              });


              $(function () {
                  moment.locale('fr');
                  $(".p-date").map((x, i) => {
                      i.innerText = moment.unix(i.dataset.createdat).local().fromNow();
                  });
              });
          });


      </script>


      <script>
// Targets all textareas with class "txta"
let textareas = document.querySelectorAll('.txta'),
    hiddenDiv = document.createElement('div'),
    content = null;

// Adds a class to all textareas
for (let j of textareas) {
  j.classList.add('txtstuff');
}

// Build the hidden div's attributes

// The line below is needed if you move the style lines to CSS
// hiddenDiv.classList.add('hiddendiv');

// Add the "txta" styles, which are common to both textarea and hiddendiv
// If you want, you can remove those from CSS and add them via JS
hiddenDiv.classList.add('txta');

// Add the styles for the hidden div
// These can be in the CSS, just remove these three lines and uncomment the CSS
hiddenDiv.style.display = 'none';
hiddenDiv.style.whiteSpace = 'pre-wrap';
hiddenDiv.style.wordWrap = 'break-word';

// Loop through all the textareas and add the event listener
for(let i of textareas) {
  (function(i) {
    // Note: Use 'keyup' instead of 'input'
    // if you want older IE support
    i.addEventListener('input', function() {
      
      // Append hiddendiv to parent of textarea, so the size is correct
      i.parentNode.appendChild(hiddenDiv);
      
      // Remove this if you want the user to be able to resize it in modern browsers
      i.style.resize = 'none';
      
      // This removes scrollbars
      i.style.overflow = 'hidden';

      // Every input/change, grab the content
      content = i.value;

      // Add the same content to the hidden div
      
      // This is for old IE
      content = content.replace(/\n/g, '<br>');
      
      // The <br ..> part is for old IE
      // This also fixes the jumpy way the textarea grows if line-height isn't included
      hiddenDiv.innerHTML = content + '<br style="line-height: 3px;">';

      // Briefly make the hidden div block but invisible
      // This is in order to read the height
      hiddenDiv.style.visibility = 'hidden';
      hiddenDiv.style.display = 'block';
      i.style.height = hiddenDiv.offsetHeight + 'px';

      // Make the hidden div display:none again
      hiddenDiv.style.visibility = 'visible';
      hiddenDiv.style.display = 'none';
    });
  })(i);
}
      </script>

  {% endblock %}
