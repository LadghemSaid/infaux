{% extends '/base.html.twig' %}

{% block title %}
    PopWeb - Blog
{% endblock %}
{% block gtag %}
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-107718823-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'UA-107718823-2');
    </script>
{% endblock %}
{% block meta_description %}
    <meta name="description"
          content="Agence web à Lens. Conception et développement de sites sur mesure. Communication digitale, référencement SEO Google."/>{% endblock %}
{% block meta_keywords %}
    <meta name="keywords"
          content="Agence web de communication web marketing, stratégie digitale à Lens, France, creation site internet, agence de développement web, Création site internet, Lens, Lille, France, creation site internet, 59, 62, Nord Pas de Calais, Nord, Haut de France, création site internet vitrine, community management entreprise, community management personnel, création boutique en ligne, site internet, site web, création site internet boutique en ligne, Création site web, 75, Paris, Création site web e commerce, agence de référencement, agence seo, seo, référencement naturel, web marketing, agence web, agence de communication, vidéo promotionnelle, vidéo commercial, création site catalogue, création site internet responsive, généré du trafic sur mon site internet, première page google, référencement google, création de site internet france, conseil et webdesign, référencement internet, agence web, site internet responsive, site responsive, création et optimisation de site web, web design et développement de site internet, communication digitale, webmarketing, création site internet boutique en ligne, boutique en ligne, créer boutique en ligne, refonte boutique en ligne, refonte site internet e-commerce, responsive web design, refonte site internet responsive, site adaptable, site internet, site web, création site internet, création site web, responsive, création site internet e-commerce"/>{% endblock %}
{% block meta_robots %}
    <meta name="robots" content="unavailable_after: [date ]">{% endblock %}
{% block google %}
    <meta name="google" content="unavailable_after: [date ]">{% endblock %}

{% block style_custom %}

    <style>

    </style>
{% endblock %}
{% block body %}

    {% for message in app.flashes('success') %}
        <div class="alert alert-success">
            {{ message }}
        </div>
    {% endfor %}
    {% for message in app.flashes('error') %}
        <div class="alert alert-danger">
            {{ message }}
        </div>
    {% endfor %}
    <div class="container">

        {% for post in posts %}


            <div class="post-container">
                <div class="content">
                    <div class="header">
                        <img src="https://images.unsplash.com/photo-1463453091185-61582044d556?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1650&q=80"
                             alt="" class="img">
                    <div class="l-post">
                        <p class="username"><strong>{{ post.user.username }}</strong></p>
                        <p class="text">{{ post.text }}</p>
                    </div>
                    </div>

                    <div class="footer">
                        <p class="icons">
                        <form name="like" method="post"
                              action="{{ path('like.add',{"entity":"post",'id':post.id}) }}" class="likeForm">
                            <button type="submit" id="like_submit" name="like[submit]" class="btn btn-pink ">
                                <i class="fa fa-thumbs-up">
                                        <span class="number">
                                            {{ post.likes|length }}
                                        </span>
                                </i>
                            </button>
                        </form>
                        </p>
                        <p class="icons">

                        <form name="report" method="post"
                              action="{{ path('post.addfollow',{"entity":"post",'id':post.id}) }}" class="reportForm">
                            <button type="submit" id="report_submit" name="report[submit]" class="btn btn-pink ">
                                <i class="fa fa-flag"><span
                                            class="number ">{{ post.followedBy | length }} epingler</span></i>
                            </button>
                        </form>
                        </p>
                        <p class="icons">
                            <i class="fa fa-comment"><span class="number">{{ post.comments | length }}</span></i>
                        </p>
                        <p class="icons">
                            <i class="fa fa-clock-o"><span data-createdAt="{{ post.createdAt | date('U') }}"
                                                           class="number p-date">{{ post.createdAt | date('U') }}</span></i>

                        </p>
                        <p class="icons">
                        <form name="report" method="post"
                              action="{{ path('report.add',{"entity":"post",'id':post.id}) }}" class="reportForm">
                            <button type="submit" id="report_submit" name="report[submit]" class="btn btn-pink ">
                                <i class="fa fa-flag"><span class="number ">Signalez</span></i>
                            </button>
                        </form>
                        </p>

                    </div>
                </div>
                {% if app.user %}
                    <div class="formComment">
                        <form name="comment" method="post" action="{{ path('comment.add',{'id':post.id}) }}"
                              class="commentForm">
                            <div class="form-group">
                                <label class="sr-only required" for="comment_textComment">Commentaire</label>
                                <textarea id="comment_textComment" name="comment[textComment]" required="required"
                                          class="commentForm__textarea form-control"
                                          placeholder="Votre commentaire ..."></textarea>
                            </div>
                            <div class="d-flex justify-content-end">
                                <div class="form-group">
                                    <button type="submit" id="comment_submit" name="comment[submit]"
                                            class="btn btn-pink btn">Envoyer
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                {% endif %}
                {% set comment = post.comments | last %}


                <div class="wrapper-comments">
                    <a data-page="0" data-post="{{ post.id }}" class="btn btn-primaire view-more-button"
                       onclick="getNextComment(event)"
                       href="{{ path('comment.paginate',{'post': post.id}) }}">Voir plus</a>

                    <div class="nextComment">

                    </div>
                    <div class="comments-container">
                        <div class="content">
                            <div class="header">
                                <img src="https://images.unsplash.com/photo-1463453091185-61582044d556?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1650&q=80"
                                     alt="" class="img">
                                     <div class="l-post">
                                    <p class="username"><strong>{{ comment.user }}</strong></p>

                                    <p class="text">{{ comment.textComment }} </p>
                             </div>   
                            </div>

                            <div class="footer">
                                <p class="icons">
                                <form name="like" method="post"
                                      action="{{ path('like.add',{"entity":"comment",'id':comment.id}) }}"
                                      class="likeForm">
                                    <button type="submit" id="like_submit" name="like[submit]" class="btn btn-pink ">
                                        <i class="fa fa-thumbs-up">
                                        <span class="number">
                                            {{ comment.likes|length }}
                                        </span>
                                        </i>
                                    </button>
                                </form>
                                </p>
                                <p class="icons">
                                    <i class="fa fa-clock-o"><span data-createdAt="{{ comment.createdAt | date('U') }}"
                                                                   class="number p-date">{{ comment.createdAt | date('U') }}</span></i>

                                </p>
                                <p class="icons">
                                <form name="report" method="post"
                                      action="{{ path('report.add',{"entity":"post",'id':post.id}) }}"
                                      class="reportForm">
                                    <button type="submit" id="report_submit" name="report[submit]"
                                            class="btn btn-pink ">
                                        <i class="fa fa-flag"><span class="number ">Signalez</span></i>
                                    </button>
                                </form>
                                </p>


                            </div>
                        </div>

                    </div>
                </div>


            </div>
        {% endfor %}
        {{ knp_pagination_render(posts) }}

    </div>

    <div class="page-load-status">
        <p class="infinite-scroll-request">Chargement...</p>
        <p class="infinite-scroll-last">Plus aucun post a afficher</p>
        <p class="infinite-scroll-error">No more pages to load</p>
    </div>
{% endblock %}


  {% block javascripts %}
      <script src="https://unpkg.com/infinite-scroll@3/dist/infinite-scroll.pkgd.min.js"></script>
      <script>
          //Comment Ajax load
          function getNextComment(event) {
              var compteur = 0;
              event.preventDefault()
              console.log(parseInt(event.target.dataset.page) + 1)
              var url = $(event.target).attr('href');
              var newUrl = "/comment/post/" + event.target.dataset.post + "?page=" + (parseInt(event.target.dataset.page) + 1);
              const containerComment = $(event.target).next('.nextComment')[0];

              $.get(url, function (data, response) {
                  if (response == "success") {

                      console.log("External content loaded successfully!", data);
                      $(data).prependTo(containerComment).fadeIn("slow");
                      $(event.target).attr('href', newUrl)
                      $(event.target).attr('data-page', (parseInt(event.target.dataset.page) + 1))
                  }
                  if (response == "error") {
                      console.log("Error: " + xhr.status + ": " + xhr.statusText);
                  }
              });
          }


          document.addEventListener("DOMContentLoaded", function (event) {


              //Post infinite scroll
              var infiniteScroll = $('.container').infiniteScroll({
                  // options
                  path: '.next a',
                  append: '.post-container',
                  history: false,
                  elementScroll: false,
                  hideNav: '.pagination',
                  status: '.page-load-status'
              });
              infiniteScroll.on('load.infiniteScroll', function () {
                  $(function () {
                      moment.locale('fr');
                      $(".p-date").map((x, i) => {
                          i.innerText = moment.unix(i.dataset.createdat).local().fromNow();
                      });
                  });
              });

              $(function () {
                  moment.locale('fr');
                  $(".p-date").map((x, i) => {
                      i.innerText = moment.unix(i.dataset.createdat).local().fromNow();
                  });
              });
          });


      </script>
      {{ encore_entry_script_tags('app') }}

      {% if app.user %}
          <script type="text/javascript">
              const _receiver = document.getElementById('mercure-content-receiver');
              const numberNotifs = $('.number_notif');

              const url = new URL('{{ mercure_publish_url }}');

              url.searchParams.append('topic', '/message');
              //  const eventSource = new EventSource(url, {withCredentials: true});
             // const eventSource = new EventSource(url, {withCredentials: true,headers: {Authorization: bearer}});

              const eventSource =  new EventSourcePolyfill(url, {
                  headers: {
                      'Authorization': 'Bearer {{ bearerToken }}'
                  }
              });

              eventSource.onmessage = (evt) => {
                  const data = JSON.parse(evt.data);
                  if (!data.message) {
                      return;
                  }
                  numberNotifs[0].innerText++;
                  _receiver.insertAdjacentHTML('beforeend', `<div class="message">${data.message}</div>`);
              };
          </script>
      {% endif %}
  {% endblock %}
