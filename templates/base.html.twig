<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Infaux{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="turbolinks-cache-control" content="no-cache">
    {% block meta_description %}{% endblock %}
    {% block meta_keywords %}{% endblock %}
    {% block meta_robots %}{% endblock %}
    {% block meta_google %}{% endblock %}
    <link type="text/plain" rel="author" href="/humans.txt"/>
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">


    <link rel="icon" type="image/png" href="/img/favicon.png"/>
    <link rel="apple-touch-icon" sizes="96x96" href="/img/favicon96.png">

    <link rel="apple-touch-icon" sizes="192x192" href="/img/favicon192.png">
    <meta property="og:image" content="/img/icon.png"/>
    <meta name="theme-color" content="#00103e">


    <link rel="stylesheet" href="{{ asset('/font/icomoon/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.0.0/animate.min.css"/>
    <script type="text/javascript"
            src="{{ preload(asset('js/tarteaucitron/tarteaucitron.js'), { as: 'script', importance: 'low' }) }}"></script>

    <script type="text/javascript">
        tarteaucitron.init({
            "privacyUrl": "", /* Privacy policy url */

            "hashtag": "#tarteaucitron", /* Open the panel with this hashtag */
            "cookieName": "tarteaucitron", /* Cookie name */

            "orientation": "bottom", /* Banner position (top - bottom) */
            "showAlertSmall": false, /* Show the small banner on bottom right */
            "cookieslist": true, /* Show the cookie list */

            "adblocker": false, /* Show a Warning if an adblocker is detected */
            "AcceptAllCta": true, /* Show the accept all button when highPrivacy on */
            "highPrivacy": false, /* Disable auto consent */
            "handleBrowserDNTRequest": false, /* If Do Not Track == 1, disallow all */

            "removeCredit": true, /* Remove credit link */
            "moreInfoLink": false, /* Show more info link */
            "useExternalCss": false, /* If false, the tarteaucitron.css file will be loaded */

            //"cookieDomain": ".my-multisite-domaine.fr", /* Shared cookie for multisite */

            "readmoreLink": "/cookiespolicy" /* Change the default readmore link */
        });

        (tarteaucitron.job = tarteaucitron.job || []).push('recaptcha');
        tarteaucitron.user.gajsUa = 'UA-107718823-2';
        tarteaucitron.user.gajsMore = function () { /* add here your optionnal _ga.push() */
        };


    </script>
    {% block gtag %}{% endblock %}

    {% block stylesheets %}

    {% endblock %}

    {{ encore_entry_link_tags('main') }}

</head>

<body>

{% include "header.html.twig" %}

<div class="infinite-scroll-wrapper">
    {% block body %}
    {% endblock %}
</div>


{# <a aria-label="Button permettant de retourner en haut de la page" id="scrollToTop">Up !</a> #}

<script src="{{ preload('https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js', { as: 'script' }) }}"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"
></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment-with-locales.min.js"
></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js@1.2.2/src/toastify.js"></script>


<script>

    function hideModal() {
        $(".modal").removeClass("in");
        $(".modal-backdrop").remove();
        $('body').removeClass('modal-open');
        $('body').css('padding-right', '');
        $(".modal").hide();
    }

    function detectInputType(event) {
        switch(event.pointerType) {
            case "mouse":
                //Long press sur les posts
                var pressTimerPost;
                $(".post-container").mouseup(function(){
                    clearTimeout(pressTimerPost);
                    // Clear timeout
                    return false;
                }).mousedown(function(event){
                    // Set timeout

                    pressTimerPost = window.setTimeout(function() {
                        $($(event.currentTarget).find('.modal')[1]).modal('show')
                    },1000);
                    return false;
                });

                //LongPress sur les commentaire
                var pressTimerComment;
                $(".comments-container").mouseup(function(){
                    clearTimeout(pressTimerComment);
                    // Clear timeout
                    return false;
                }).mousedown(function(event){
                    // Set timeout

                    pressTimerComment = window.setTimeout(function() {
                        $($(event.currentTarget).find('.modal')[1]).modal('show')
                    },1000);
                    return false;
                });
                break;
            case "pen":
                /* pen/stylus input detected */
                break;
            case "touch":
                //Long press sur les posts
                var pressTimerPost;
                $(".post-container").on('pointerup',function(){
                    clearTimeout(pressTimerPost);
                    // Clear timeout
                    return false;
                }).on('pointerdown',function(event){
                    // Set timeout

                    pressTimerPost = window.setTimeout(function() {
                        $($(event.currentTarget).find('.modal')[1]).modal('show')
                    },1000);
                    return false;
                });

                //LongPress sur les commentaire
                var pressTimerComment;
                $(".comments-container").on('pointerup',function(){
                    clearTimeout(pressTimerComment);
                    // Clear timeout
                    return false;
                }).on('pointerdown',function(event){

                    // Set timeout

                    pressTimerComment = window.setTimeout(function() {
                        $($(event.currentTarget).find('.modal')[1]).modal('show')
                    },1000);
                    return false;
                });
                break;
            default:
            /* pointerType is empty (could not be detected)
            or UA-specific custom type */
        }
    }


    document.addEventListener("DOMContentLoaded", function (event) {


        $(function () {
            //Header hidden au scroll bas
            var didScroll;
            var lastScrollTop = 0;
            var delta = 5;
            var navbarHeight = $('.logo-header').outerHeight();

            $(window).scroll(function(event){
                didScroll = true;
            });

            setInterval(function() {
                if (didScroll) {
                    hasScrolled();
                    didScroll = false;
                }
            }, 250);

            function hasScrolled() {
                var st = $(this).scrollTop();

                // Make sure they scroll more than delta
                if(Math.abs(lastScrollTop - st) <= delta)
                    return;

                // If they scrolled down and are past the navbar, add class .nav-up.
                // This is necessary so you never see what is "behind" the navbar.
                if (st > lastScrollTop && st > navbarHeight){
                    // Scroll Down
                    $('.logo-header').removeClass('nav-down').addClass('nav-up');
                } else {
                    // Scroll Up
                    if(st + $(window).height() < $(document).height()) {
                        $('.logo-header').removeClass('nav-up').addClass('nav-down');
                    }
                }

                lastScrollTop = st;
            }


            window.addEventListener("pointerdown", detectInputType, false);







            //Converstion des date en affiche moment js
            moment.locale('fr');
            $(".p-date").map((x, i) => {
                i.innerText = moment.unix(i.dataset.createdat).local().fromNow();
            });
        });
    });


    var btn = $('#scrollToTop');

    btn.on('click', function (e) {
        e.preventDefault();
        $('html, body').animate({scrollTop: 0}, '300');
    });

</script>


{% if app.user %}
    {{ encore_entry_script_tags('eventSource') }}

    <script>
        //fonction d'affichage du bouton submit (form comment)
        function affiche_comment(event){
            console.log(  $($(event.target).parents("form")[0]).find('button')[0])
            event.target.focus()
            //$($(event.target).parents("form")[0]).find('button')[0].disabled="";
            $($(event.target).parents("form")[0]).find('button')[0].style.opacity = 1;
            //$('#postForm').addClass('selected');
        }
        function afficheplus_comment(event){
            console.log(event.target)
            const str =   event.target.value;
            if (str.length == 0) {
                $($(event.target).parents("form")[0]).find('button')[0].style.opacity = 0;
              //  $($(event.target).parents("form")[0]).find('button')[0].disabled = "true";
             //   $('#postForm').removeClass('selected');

            }


        }

        navigator.serviceWorker.register('/sw.js', {scope: '/'}).then(function (registration) {
            console.log("sw registred :", registration);
        }).catch(registrationError => {
            console.log("registration sw error:", registrationError)
        });

        function notify(message, registration) {

            if (message === "Message reçu") {
                //Cas d'un message de la messagerie
                if (window.location.pathname === "/chat") {

                } else {

                    if ($('#notif-messagerie').length > 0) {
                        $('#notif-messagerie')[0].innerText++;
                    } else {
                        $('.chat-i').html("<a href='{{ path('index.chat') }}'><i class='icon-bubbles3'></i><span id='notif-messagerie' class='number_notif notif'>1</span></a>")
                    }

                    Toastify({
                        text: "Message recu !",
                        duration: 3000,
                        close: true,
                        gravity: "top", // `top` or `bottom`
                        position: 'left', // `left`, `center` or `right`
                        stopOnFocus: true, // Prevents dismissing of toast on hover
                        className: "success",
                        destination: "/chat",
                        onClick: function () {
                        } // Callback after click
                    }).showToast();

                    registration.showNotification('Tu as reçu une notifications !', {
                        body: message,
                        icon: '/img/logo_infaux.png',
                        badge: '/img/logo_infaux.png',
                        data: {
                            url: "/chat"
                        },
                        silent: true,

                    });

                }


            } else {
                if ($('#notif').length > 0) {
                    $('#notif')[0].innerText++;
                } else {
                    $('.header-notfication-bell').html("<i class='icon-bell'></i><span id='notif' class='number_notif notif'>1</span>")
                }

                Toastify({
                    text: "Tu as reçu une notifications !",
                    duration: 3000,
                    close: true,
                    gravity: "top", // `top` or `bottom`
                    position: 'left', // `left`, `center` or `right`
                    stopOnFocus: true, // Prevents dismissing of toast on hover
                    className: "success",
                    onClick: function () {
                    } // Callback after click
                }).showToast();

                registration.showNotification('Tu as reçu une notifications !', {
                    body: message,
                    icon: '/img/logo_infaux.png',
                });
            }


        }

        const url = new URL('{{ mercure_publish_url }}');
        url.searchParams.append('topic', '/message');

        const eventSource = new EventSourcePolyfill(url, {
            headers: {
                'Authorization': 'Bearer {{ token_generator.generateToken(app.user) }}',
            }
        }, {withCredentials: true});

        Notification.requestPermission(function (result) {
            if (result === 'granted') {
                navigator.serviceWorker.ready.then(function (registration) {

                    eventSource.onmessage = (evt) => {
                        let data = JSON.parse(evt.data);
                        if (!data.message) {
                            return;
                        }
                        notify(data.message, registration)

                    };
                })

            } else {
                console.log("Notification refused")
            }

        })
    </script>


{% endif %}

<script>




</script>

{% block javascripts %}




{% endblock %}

</body>
</html>
